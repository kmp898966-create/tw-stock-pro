import streamlit as st
import pandas as pd
# ... å¾Œé¢åŸæœ¬çš„ç¨‹å¼ç¢¼ç¶­æŒä¸è®Š
from FinMind.data import DataLoader
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# åˆå§‹åŒ–
dl = DataLoader()

st.set_page_config(layout="wide", page_title="å°è‚¡æˆäº¤é‡å¯†é›†å€åˆ†æå·¥å…·")

# --- å´é‚Šæ¬„è¨­å®š ---
st.sidebar.header("æŸ¥è©¢è¨­å®š")
stock_id = st.sidebar.text_input("è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼", value="2330")
start_date = st.sidebar.date_input("é–‹å§‹æ—¥æœŸ", value=pd.to_datetime("2026-02-01"))
bin_size = st.sidebar.slider("åƒ¹æ ¼å€é–“ç²¾ç´°åº¦ (Bins)", 20, 100, 50)

# --- è³‡æ–™è™•ç†é‚è¼¯ ---
def process_and_calculate_vp(df, bins=50):
    # 1. æ¬„ä½è‡ªå‹•å°é½Š (Map FinMind columns to standard names)
    rename_map = {
        'max': 'high',
        'min': 'low',
        'Trading_Volume': 'Volume'
    }
    df = df.rename(columns=rename_map)
    
    # 2. è¨ˆç®—æˆäº¤é‡åˆ†ä½ˆ
    df['price_bin'] = pd.cut(df['close'], bins=bins)
    vp = df.groupby('price_bin', observed=True)['Volume'].sum().reset_index()
    vp['price_mid'] = vp['price_bin'].apply(lambda x: x.mid)
    return df, vp

# --- ä¸»ç¨‹å¼ ---
try:
    # æŠ“å–è³‡æ–™
    df_raw = dl.taiwan_stock_daily(
        stock_id=stock_id,
        start_date=start_date.strftime('%Y-%m-%d')
    )

    if df_raw is None or df_raw.empty:
        st.warning("âš ï¸ æ­¤å€é–“æŸ¥ç„¡è³‡æ–™ï¼Œè«‹æª¢æŸ¥æ—¥æœŸè¨­å®šï¼ˆé¿é–‹å‡æ—¥æˆ–è¨­å®šæ›´æ—©çš„æ—¥æœŸï¼‰ã€‚")
    else:
        # è™•ç†è³‡æ–™
        df, vp_data = process_and_calculate_vp(df_raw, bin_size)
        poc_price = vp_data.loc[vp_data['Volume'].idxmax(), 'price_mid']

        st.title(f"ğŸ“Š {stock_id} æˆäº¤é‡é›†çµå€é–“åˆ†æ")

        # --- ç¹ªåœ– ---
        fig = make_subplots(rows=1, cols=2, shared_yaxes=True, 
                           column_widths=[0.75, 0.25], horizontal_spacing=0.03,
                           subplot_titles=("Kç·šèµ°å‹¢", "æˆäº¤é‡åˆ†ä½ˆ (Volume Profile)"))

        # å·¦åœ–ï¼šKç·š
        fig.add_trace(go.Candlestick(x=df['date'], open=df['open'], high=df['high'],
                                     low=df['low'], close=df['close'], name="Kç·š"), row=1, col=1)

        # å³åœ–ï¼šæ©«å‘æˆäº¤é‡
        fig.add_trace(go.Bar(x=vp_data['Volume'], y=vp_data['price_mid'], 
                             orientation='h', name='æˆäº¤é‡',
                             marker_color='rgba(100, 150, 255, 0.6)'), row=1, col=2)

        # æ¨™è¨» POC
        fig.add_hline(y=poc_price, line_dash="dash", line_color="red", 
                      annotation_text=f"å¤§é‡å€: {poc_price}", row=1, col=1)

        fig.update_layout(height=700, showlegend=False, xaxis_rangeslider_visible=False)
        st.plotly_chart(fig, use_container_width=True)

      # --- æ•¸æ“šé¢æ¿ï¼šä¸­æ–‡åŒ–èˆ‡ç¾åŒ–å„ªåŒ–ç‰ˆ ---
        st.subheader("ğŸ’¡ é—œéµåˆ†æçœ‹æ¿")
        col_metric, col_table = st.columns([1, 2])
        
        with col_metric:
            st.metric("ç•¶å‰æœ€å¤§é‡æˆäº¤åƒ¹ (POC)", f"{poc_price:.2f} å…ƒ")
            st.write("---")
            st.caption("è¨»ï¼šç´…è™›ç·šä»£è¡¨æ­¤å€é–“å…§æˆäº¤é‡æœ€é›†ä¸­çš„ä½ç½®ï¼Œé€šå¸¸å…·æœ‰å¼·å¤§çš„æ”¯æ’æˆ–å£“åŠ›åŠ›é“ã€‚")
            
        with col_table:
            st.write("ğŸ“‹ **æˆäº¤é‡æœ€é›†ä¸­åƒ¹æ ¼å€é–“æ’å**")
            
            # å–å¾—å‰ä¸‰å¤§å€é–“è³‡æ–™
            top_3_df = vp_data.nlargest(3, 'Volume').copy()
            
            # æ ¼å¼åŒ–è¡¨æ ¼å…§å®¹ï¼š
            # 1. åƒ¹æ ¼å€é–“è½‰ç‚ºä¸­æ–‡å­—ä¸² (1764.57 ~ 1775.32)
            top_3_df['åƒ¹æ ¼å€é–“'] = top_3_df['price_bin'].apply(lambda x: f"{x.left:.2f} ~ {x.right:.2f}")
            
            # 2. æˆäº¤é‡è½‰ç‚ºã€Œè¬å¼µã€æˆ–åŠ ä¸Šåƒåˆ†ä½ï¼Œä¸¦æ”¹ä¸­æ–‡å
            top_3_df['ç´¯ç©æˆäº¤é‡ (å¼µ)'] = top_3_df['Volume'].apply(lambda x: f"{int(x):,}")
            
            # 3. æ’é™¤æ‰ä¸å¿…è¦çš„æ¬„ä½èˆ‡ Index åºè™Ÿ
            display_df = top_3_df[['åƒ¹æ ¼å€é–“', 'ç´¯ç©æˆäº¤é‡ (å¼µ)']].reset_index(drop=True)
            
            # é¡¯ç¤ºè¡¨æ ¼ (ä½¿ç”¨ st.dataframe æˆ– st.table)
            st.table(display_df)

except Exception as e:

    st.error(f"åŸ·è¡Œå‡ºéŒ¯: {e}")


